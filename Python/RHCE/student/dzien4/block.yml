---
- name: Konfiguracja serwera czasu
  hosts: all
  vars:
    konfig: /etc/chrony.conf
  tasks:
    - name: Backup configu
      fetch:
        src: '{{ konfig }}'
        dest: /tmp

    - block:
        - name: Rekonfiguracja
          lineinfile:
            path: '{{ konfig }}'
            regexp: "^server"
            line: "servera gdansk iburst"
          notify: Restart uslugi

        - name: Uruchomienie handlersa
          meta: flush_handlers

      rescue:
        - name: Przywrocenie backupu
          copy:
            src: "/tmp/{{ ansible_hostname }}{{ konfig }}"
            dest: '{{ konfig }}'
          notify: Restart uslugi

  handlers:
    - name: Restart uslugi
      systemd:
        name: chronyd
        state: restarted


